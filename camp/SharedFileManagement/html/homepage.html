<!DOCTYPE html>
<html lang="zh-CN">
<body>
<meta charset="utf-8">
<script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>


<table>
    <td>
        <table id="left">
            <tr>
                <td><img src="../SFM?method=getHeadImg" alt="头像" id="headImg"></td>
                <td id="nickname">nickname</td>
            </tr>
            <tr>
                <td>
                    <button type="button" id="personalSpace">个人空间</button>
                </td>
            </tr>
            <tr>
                <td>
                    <button type="button" id="departmentSpace">部门空间</button>
                </td>
            </tr>
            <tr>
                <td>
                    <button type="button" id="group">群组</button>
                </td>
            </tr>
            <tr>
                <td>
                    <button type="button" id="friend">好友</button>
                </td>
            </tr>
            <tr>
                <td>
                    <button type="button" id="profile">个人资料</button>
                </td>
            </tr>
            <tr>
                <td>
                    <button type="button" id="logout">登出</button>
                </td>
            </tr>
        </table>
    </td>
    <td>
        <table id="right">
            <tr>
                <div id="manu">
                    <button type="button" id="sort">按xxx排序</button>
                    <button type="button" id="share">分享</button>
                    <button type="button" id="delete">删除</button>
                    <button type="button" id="download">下载</button>
                    <a type="button" class="upload">
                        <input type="file" id="file" multiple="multiple" onchange="upload()"/>
                        <button type="button">上传</button>
                    </a>
                    <!--<button type="button" id="newFolder">新建文件夹</button>-->
                    <img src="img/newFolder.png" alt="新建文件夹" id="newFolder" onclick="newFolder()">
                    <button type="button" id="multi">多选</button>
                    <button type="button" id="view">视图</button>
                </div>
            </tr>

            <tr>
                <div id="list">

                </div>
            </tr>
        </table>
    </td>
</table>

</body>
</html>

<script>
    "use strict";
    var user;
    var select;
    $(document).ready(function(){
        $.ajax({//给user赋值
            url:'../SFM?method=getUserJSON',
            type:'get',
            async: true,
            dataType:"json",
            success: function(result){
                user = result;
                //最好还是把逻辑写在后台
                //setHeadImg("../webapps/AllUsers/" + user.username + "/headImg.png");//注意！因为是由服务端查询，路径要按服务端的写
                $("#nickname").text(user.nickname);
            },
            error: function(XMLHttpRequest){
                alertError(XMLHttpRequest);
            },
            timeout: 3000
        });
        $("#left button").click(function (){
            select = this.innerText;//getSelect
        });
    });
    function newFolder(){

    }
    function getUser(){

    }
    function setHeadImg(filename){//注意！因为是由服务端查询，路径要按服务端的写
        $.ajax({
            url:"../SFM?method=isFileExist",
            data:{"file":filename},
            success: function (result){
                if(result === "true"){
                    $("#headImg").attr('src',"../AllUsers/"+ user.username +"/headImg.png");
                }else{
                    $("#headImg").attr('src',"../AllUsers/defaultHeadImg2.png");
                }
            }
        });
    }
    function upload() {
        const maxSize = 1024 * 1024 * 500;
        const formData = new FormData();
        const f = document.getElementById("file");
        for ( let i = 0; i < f.files.length; i++) {
            if(f.files[i].size > maxSize){
                alert("单个文件最大不能超过500m(524288000)！\n"+ f.files[i].name + "大小为" + f.files[i].size);
                continue;
            }
            let strname="file"+i;
            //将参数以键值对的形式添加到formDate构造函数
            formData.append(strname, f.files[i]);
        }
        $.ajax({
            url:"../SFM/upload",
            type:'POST',
            data:formData,
            async:true,
            cache:false,
            contentType:false,
            processData:false,
            success:function(data){
                alert("上传成功");
            },
            error: function(XMLHttpRequest) {
                alertError(XMLHttpRequest);
            }
        });
        const parent = f.parentElement;
        parent.removeChild(f);
        const d = document.createElement('input');
        d.setAttribute('type', 'file');
        d.setAttribute('class', 'change');
        d.setAttribute('id', 'file');
        d.setAttribute('multiple', 'multiple');
        d.setAttribute('onchange', 'upload()');
        parent.insertBefore(d,parent.children[0]);
    }
    function alertError(XMLHttpRequest) {
        let msg = XMLHttpRequest.responseText;
        msg = msg.substring(msg.indexOf("消息"));
        msg = msg.substring(msg.indexOf(" ") + 1, msg.indexOf("</p>"));
        alert(msg);
        if (msg === "会话失效，请重新登录") {
            window.open("login.html", "_self");
        }
    }
</script>
<style>
    #headImg{
        width: 50px;
        height: 50px;
        padding-right: 0;
    }
    #newFolder{
        width: 30px;
        height: 30px;
    }
    #nickname{
        font-size: 20px;
        padding-left: 0;
    }
    .upload {
        padding: 1px 1px;
        height: 20px;
        position: relative;
    }
    #file{
        position: absolute;
        overflow: hidden;
        width: 50px;
        right: 0;
        top: 0;
        opacity: 0;
    }

</style>